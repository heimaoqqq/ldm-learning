# LDM (Latent Diffusion Model) é…ç½®æ–‡ä»¶

# VAE ç›¸å…³é…ç½® (ä½¿ç”¨é¢„è®­ç»ƒçš„VQ-VAE)
vae:
  model_path: "/kaggle/input/vae-best-fid/adv_vqvae_best_fid.pth"  # Kaggle VAEæ¨¡å‹è·¯å¾„
  in_channels: 3
  latent_dim: 256
  num_embeddings: 512
  beta: 0.25
  vq_ema_decay: 0.99
  groups: 32
  freeze: true  # å†»ç»“VAEå‚æ•°

# æ•°æ®é›†é…ç½®
dataset:
  root_dir: "/kaggle/input/dataset"  # Kaggleæ•°æ®é›†è·¯å¾„
  batch_size: 6  # ğŸ¯ å¹³è¡¡ç‚¹ï¼šä¿æŒåˆç†batch sizeä½†é¿å…OOM
  num_workers: 2  # ä¿æŒ2ä¸ªworkerså‡å°‘CPUå†…å­˜å ç”¨
  val_split: 0.2
  image_size: 256

# æ‰©æ•£æ¨¡å‹é…ç½®
diffusion:
  timesteps: 1000  # è®­ç»ƒæ—¶æ€»æ‰©æ•£æ­¥æ•°
  noise_schedule: "cosine"  # ğŸ¯ ä¿æŒä½™å¼¦è°ƒåº¦
  beta_start: 0.00085  # ğŸ¯ è¾ƒå°èµ·å§‹å€¼
  beta_end: 0.012  # ğŸ¯ è¾ƒå°ç»ˆæ­¢å€¼
  scheduler_type: "ddim"  # ğŸ†• ä½¿ç”¨DDIMè°ƒåº¦å™¨ (ddpm/ddim)
  clip_denoised: true

# U-Net ç½‘ç»œç»“æ„é…ç½®
unet:
  # è¾“å…¥ç»´åº¦
  in_channels: 256  # æ½œåœ¨ç©ºé—´é€šé“æ•°ï¼Œä¸VAEçš„latent_dimä¸€è‡´
  out_channels: 256  # è¾“å‡ºé€šé“æ•° (é¢„æµ‹å™ªå£°)
  model_channels: 192  # ğŸ”§ ä¿®å¤ï¼š192èƒ½è¢«8,16,24,32ç­‰å¤šç§å¤´æ•°æ•´é™¤
  
  # æ—¶é—´åµŒå…¥
  time_embed_dim: 768  # ğŸ”§ ä¿®å¤ï¼š768 = 192 * 4ï¼Œä¿æŒæ¯”ä¾‹å…³ç³»
  
  # æ¡ä»¶åµŒå…¥ (èº«ä»½æ ‡ç­¾)
  num_classes: 31  # ç±»åˆ«æ•°é‡ (ID_1åˆ°ID_31ï¼Œå…±31ä¸ªç”¨æˆ·)
  class_embed_dim: 384  # ğŸ”§ ä¿®å¤ï¼š384 = 192 * 2ï¼Œä¿æŒæ¯”ä¾‹å…³ç³»
  
  # ç½‘ç»œå±‚é…ç½®
  num_res_blocks: 3  # ğŸ¯ ä¿æŒ3å±‚ï¼Œè¿™å¯¹è´¨é‡å¾ˆé‡è¦
  attention_resolutions: [8, 16]  # ğŸ¯ å»æ‰æœ€ç»†ç²’åº¦[4]ï¼Œæ³¨æ„åŠ›å¾ˆè€—å†…å­˜
  channel_mult: [1, 2, 4, 6]  # ğŸ¯ é™ä½æœ€åä¸€å±‚ï¼š[1,2,4,8]â†’[1,2,4,6]
  num_heads: 8  # ğŸ”§ ä¿®å¤ï¼š192èƒ½è¢«8æ•´é™¤ï¼Œ192/8=24(æ¯ä¸ªå¤´çš„ç»´åº¦)
  use_scale_shift_norm: true  # ä½¿ç”¨æ¡ä»¶å½’ä¸€åŒ–
  dropout: 0.1  # Dropoutç‡
  
  # æ¡ä»¶æœºåˆ¶
  use_cross_attention: true  # ğŸ¯ ä¿æŒäº¤å‰æ³¨æ„åŠ›ï¼Œè¿™å¯¹æ¡ä»¶ç”Ÿæˆå¾ˆé‡è¦
  use_self_attention: true   # ğŸ¯ ä¿æŒè‡ªæ³¨æ„åŠ›

# è®­ç»ƒé…ç½®
training:
  epochs: 500
  lr: 0.000005  # ğŸ”§ è¿›ä¸€æ­¥é™ä½å­¦ä¹ ç‡ï¼Œé˜²æ­¢æ•°å€¼çˆ†ç‚¸
  weight_decay: 0.01
  warmup_steps: 2000  # ğŸ”§ å¢åŠ é¢„çƒ­æ­¥æ•°ï¼Œæ›´ç¨³å®šçš„å¼€å§‹
  
  # ğŸ†• æ¢¯åº¦ç´¯ç§¯é…ç½®
  gradient_accumulation_steps: 1  # ğŸ”§ å…ˆç”¨1æ­¥ç´¯ç§¯ï¼Œç¨³å®šåå†å¢åŠ 
  
  # ä¿å­˜è®¾ç½®
  save_dir: "ldm_models"
  save_interval: 50  # æ¯éš”å¤šå°‘epochä¿å­˜ä¸€æ¬¡
  sample_interval: 15  # ğŸ¯ ç•¥å¾®é™ä½é‡‡æ ·é¢‘ç‡èŠ‚çœå†…å­˜
  log_interval: 100  # æ¯éš”å¤šå°‘æ­¥æ‰“å°æ—¥å¿—
  
  # æŸå¤±æƒé‡
  noise_loss_weight: 1.0
  
  # Classifier-Free Guidance
  use_cfg: true  # ä½¿ç”¨æ— åˆ†ç±»å™¨å¼•å¯¼
  cfg_dropout_prob: 0.1  # ğŸ”§ é™ä½CFG dropoutï¼Œå‡å°‘è®­ç»ƒå›°éš¾
  
  # æ¢¯åº¦è£å‰ª
  grad_clip_norm: 0.2  # ğŸ”§ æ›´ä¸¥æ ¼çš„æ¢¯åº¦è£å‰ª
  
  # è°ƒåº¦å™¨
  use_scheduler: true
  scheduler_type: "cosine_with_restarts"  # ğŸ¯ ä¿æŒä¼˜åŒ–è°ƒåº¦å™¨

# FIDè¯„ä¼°é…ç½®
fid_evaluation:
  enabled: true  # ğŸ¯ ä¿æŒFIDè¯„ä¼°ç›‘æ§è´¨é‡
  eval_interval: 5  # ğŸ¯ é«˜çš„è¯„ä¼°é¢‘ç‡
  num_samples: 2048  # ğŸ¯ é€‚ä¸­çš„æ ·æœ¬æ•°ï¼Œå¹³è¡¡å‡†ç¡®æ€§å’Œå†…å­˜
  batch_size: 1  # ğŸ”§ é…åˆæ¨ç†batch_sizeè°ƒæ•´ä¸º1
  max_real_samples: 2048  # ğŸ¯ é€‚ä¸­çš„çœŸå®æ ·æœ¬æ•°
  save_best_fid_model: true  # ä¿å­˜æœ€ä½³FIDæ¨¡å‹

# æ¨ç†é…ç½®
inference:
  num_inference_steps: 250  # ğŸ”§ æé«˜DDIMæ­¥æ•°åˆ°250ï¼Œè·å¾—æ›´é«˜è´¨é‡
  guidance_scale: 7.5  # CFGå¼•å¯¼å¼ºåº¦
  eta: 0.3  # ğŸ†• ä½¿ç”¨ä¸­ç­‰etaå€¼ï¼Œå¹³è¡¡è´¨é‡å’Œå¤šæ ·æ€§ (0=ç¡®å®šæ€§, 1=éšæœº)
  adaptive_eta: true  # ğŸ†• å¯ç”¨æ”¹è¿›çš„è‡ªé€‚åº”eta
  
  # é‡‡æ ·é…ç½®
  sample_batch_size: 1  # ğŸ”§ ä¿®æ”¹ä¸ºä»…ç”Ÿæˆ1å¼ å›¾ç‰‡
  num_samples_per_class: 1  # ğŸ”§ æ¯ä¸ªç±»åˆ«åªç”Ÿæˆ1ä¸ªæ ·æœ¬
  
  # ğŸ†• å½’ä¸€åŒ–é…ç½®
  normalization:
    # æ•°æ®èŒƒå›´å®šä¹‰
    data_range: [0, 1]        # åŸå§‹å›¾åƒåƒç´ èŒƒå›´
    vae_input_range: [-1, 1]  # VAEè¾“å…¥èŒƒå›´ï¼ˆç»è¿‡é¢„å¤„ç†ï¼‰
    vae_output_range: [-1, 1] # VAEè¾“å‡ºèŒƒå›´ï¼ˆtanhæ¿€æ´»ï¼‰
    final_output_range: [0, 1] # æœ€ç»ˆè¾“å‡ºå›¾åƒèŒƒå›´
    
    # æ•°å€¼ç¨³å®šæ€§é…ç½®
    latent_clamp_range: [-5, 5]    # æ½œåœ¨è¡¨ç¤ºè£å‰ªèŒƒå›´
    latent_std_threshold: 3.0      # æ½œåœ¨è¡¨ç¤ºæ ‡å‡†å·®é˜ˆå€¼
    enable_range_checking: true    # å¯ç”¨èŒƒå›´æ£€æŸ¥
    enable_adaptive_norm: true     # å¯ç”¨è‡ªé€‚åº”å½’ä¸€åŒ–
    
    # VAEè§£ç å®‰å…¨æ€§
    vae_decode_clamp: true         # å¯ç”¨VAEè§£ç è¾“å‡ºè£å‰ª
    vae_decode_range: [-1.1, 1.1] # VAEè§£ç è¾“å‡ºå®‰å…¨èŒƒå›´
  
  # è¾“å‡ºè®¾ç½®
  output_dir: "generated_samples"
  save_format: "png"

# è®¾å¤‡é…ç½®
device: "auto"  # auto, cpu, cuda
mixed_precision: true  # ğŸ¯ å¯ç”¨æ··åˆç²¾åº¦è®­ç»ƒèŠ‚çœå†…å­˜

# æ—¥å¿—é…ç½®
logging:
  use_wandb: false  # æ˜¯å¦ä½¿ç”¨wandb
  project_name: "LDM-Gait"
  experiment_name: "ldm_micro_doppler_32x32_latent"  # å¾®å¤šæ™®å‹’ç‰¹å¾å›¾å®éªŒ
  log_dir: "logs" 
