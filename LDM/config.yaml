# LDM (Latent Diffusion Model) 配置文件 - 基于Stable Diffusion轻量化版本

# VAE 相关配置 (使用预训练的VQ-VAE)
vae:
  model_path: "/kaggle/input/vae-best-fid/adv_vqvae_best_fid.pth"  
  in_channels: 3
  latent_dim: 256  # VAE潜在维度
  num_embeddings: 512
  beta: 0.25
  vq_ema_decay: 0.99
  groups: 32
  freeze: true  # 冻结VAE参数
  # VAE输出信息（用于U-Net适配）
  latent_height: 32  # 256/8 = 32
  latent_width: 32
  latent_channels: 256

# 数据集配置
dataset:
  root_dir: "/kaggle/input/dataset"  # Kaggle数据集路径
  batch_size: 8  # 🚀 轻量化后可以增大batch size
  num_workers: 2
  val_split: 0.2
  image_size: 256

# 扩散模型配置
diffusion:
  timesteps: 1000
  noise_schedule: "scaled_linear"  # 🔧 SD使用的调度
  beta_start: 0.00085
  beta_end: 0.012
  scheduler_type: "ddim"
  clip_denoised: true
  prediction_type: "epsilon"  # 预测噪声

# U-Net 网络结构配置 (基于Stable Diffusion轻量化)
unet:
  # 输入输出维度
  in_channels: 256  # 匹配VAE潜在通道数
  out_channels: 256  # 预测噪声
  
  # 基础模型配置
  model_channels: 128  # 🚀 大幅简化：320->128
  num_res_blocks: 2  # 🚀 减少ResNet块：3->2
  attention_resolutions: [4, 2]  # 🚀 简化注意力层
  channel_mult: [1, 2, 4]  # 🚀 简化通道倍数：[1,2,4,8]->[1,2,4]
  
  # 注意力配置
  num_head_channels: 32  # 🚀 减少注意力头维度
  use_spatial_transformer: true  # 使用空间transformer
  transformer_depth: 1  # 🚀 单层transformer
  
  # 条件嵌入
  num_classes: 31  # 类别数量
  use_fp16: true  # 🚀 启用半精度
  
  # 时间嵌入
  time_embed_dim: 512  # 128 * 4

# 训练配置
training:
  epochs: 200  # 🚀 减少训练轮数，更快收敛
  lr: 0.0001  # 🚀 提高学习率，轻量模型更容易训练
  weight_decay: 0.01
  warmup_steps: 1000
  
  # 梯度累积
  gradient_accumulation_steps: 1
  
  # 保存设置
  save_dir: "sd_ldm_models"
  save_interval: 25  # 更频繁保存
  sample_interval: 10  # 更频繁生成样本
  log_interval: 50
  
  # 损失配置
  loss_type: "l2"  # MSE损失
  
  # Classifier-Free Guidance
  use_cfg: true
  cfg_dropout_prob: 0.15  # SD典型值
  
  # 优化器配置
  optimizer: "adamw"
  beta1: 0.9
  beta2: 0.999
  eps: 0.00000001
  
  # 梯度裁剪
  grad_clip_norm: 1.0
  
  # 调度器
  use_scheduler: true
  scheduler_type: "cosine"

# FID评估配置
fid_evaluation:
  enabled: true
  eval_interval: 5  # 每5个epoch评估
  num_samples: 1000  # 🚀 减少样本数，快速评估
  batch_size: 16  # 更大的batch size
  max_real_samples: 1000
  save_best_fid_model: true

# 推理配置
inference:
  num_inference_steps: 250  # 🚀 减少推理步数，更快生成
  guidance_scale: 7.5
  eta: 0.0  # DDIM确定性采样
  
  # 采样配置
  sample_batch_size: 4
  num_samples_per_class: 2
  
  # 输出设置
  output_dir: "generated_samples"
  save_format: "png"

# 设备配置
device: "auto"
mixed_precision: true
use_ema: true  # 🚀 使用EMA提高生成质量
ema_decay: 0.9999

# 日志配置
logging:
  use_wandb: false
  project_name: "SD-LDM-Gait"
  experiment_name: "sd_ldm_lightweight"
  log_dir: "logs" 
